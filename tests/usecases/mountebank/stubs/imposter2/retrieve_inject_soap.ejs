function (request, state) {
    state.map = state.map || {}; // Ensure map is initialized
    const { create } = require('xmlbuilder2'); // Import xmlbuilder2

    // Helper to generate a generic SOAP success response for Retrieve
    // Helper to generate a generic SOAP success response for Retrieve
    const generateRetrieveSuccessXml = (value) => {
        const builder = create({ version: '1.0', encoding: 'utf-8' });
        const envelopeBuilder = builder.ele('soapenv:Envelope', {
                'xmlns:soapenv': 'http://schemas.xmlsoap.org/soap/envelope/',
                'xmlns:tem': 'http://tempuri.org/'
            });
        envelopeBuilder.ele('soapenv:Header').up();
        const bodyBuilder = envelopeBuilder.ele('soapenv:Body');
        const retrieveResponseBuilder = bodyBuilder.ele('tem:RetrieveResponse');
        retrieveResponseBuilder.ele('tem:Result'); // Just create the tag, will replace content

        let resultXml = builder.end({ prettyPrint: true, headless: true });
        
        // Inject the raw XML value by string replacement
        let finalXml = resultXml.replace('<tem:Result/>', '<tem:Result>' + value + '</tem:Result>')
                                .replace('<tem:Result></tem:Result>', '<tem:Result>' + value + '</tem:Result>'); // Handle both self-closing and explicit close tags

        return finalXml;
    };

    // Helper to generate a generic SOAP error response
    const generateErrorXml = (errorMessage) => {
        return create({ version: '1.0', encoding: 'utf-8' })
            .ele('soapenv:Envelope', {
                'xmlns:soapenv': 'http://schemas.xmlsoap.org/soap/envelope/',
                'xmlns:tem': 'http://tempuri.org/'
            })
            .ele('soapenv:Header').up()
            .ele('soapenv:Body')
                .ele('tem:ErrorResponse')
                    .ele('tem:Message').txt(errorMessage).up()
                .up()
            .up()
        .end({ prettyPrint: true, headless: true });
    };

    try {
        var xpath = require('xpath');
        var DOMParser = require('xmldom').DOMParser; // CORRECTED
        var doc = new DOMParser().parseFromString(request.body, 'text/xml'); // CORRECTED

        const keyNodes = xpath.select("//*[local-name()='Key' and namespace-uri()='http://tempuri.org/']", doc);

        let key = '';
        if (keyNodes.length > 0 && keyNodes[0].firstChild) {
            key = keyNodes[0].firstChild.data;
        }

        if (!key) {
            const errorMessage = "Missing Key in SOAP request body";
            return {
                statusCode: 400,
                headers: { 'Content-Type': 'application/soap+xml; charset=utf-8' },
                body: generateErrorXml(errorMessage)
            };
        }

        const value = state.map[key];

        if (value === undefined) {
            const errorMessage = "Key not found: " + key;
            return {
                statusCode: 404,
                headers: { 'Content-Type': 'application/soap+xml; charset=utf-8' },
                body: generateErrorXml(errorMessage)
            };
        }

        return {
            statusCode: 200,
            headers: { 'Content-Type': 'application/soap+xml; charset=utf-8' },
            body: generateRetrieveSuccessXml(value)
        };
    } catch (e) {
        return {
            statusCode: 500,
            headers: { 'Content-Type': 'application/soap+xml; charset=utf-8' },
            body: generateErrorXml('Internal server error: ' + e.message)
        };
    }
}