function (request, state) {
    state.map = state.map || {}; // Initialize map if it doesn't exist
    const { create } = require('xmlbuilder2'); // Import xmlbuilder2

    // Helper to generate a generic SOAP success response
    const generateSuccessXml = (message) => {
        return create({ version: '1.0', encoding: 'utf-8' })
            .ele('soapenv:Envelope', {
                'xmlns:soapenv': 'http://schemas.xmlsoap.org/soap/envelope/',
                'xmlns:tem': 'http://tempuri.org/'
            })
            .ele('soapenv:Header').up()
            .ele('soapenv:Body')
                .ele('tem:StoreXMLResponse')
                    .ele('tem:Result').txt(message).up()
                .up()
            .up()
        .end({ prettyPrint: true, headless: true });
    };

    // Helper to generate a generic SOAP error response
    const generateErrorXml = (errorMessage) => {
        return create({ version: '1.0', encoding: 'utf-8' })
            .ele('soapenv:Envelope', {
                'xmlns:soapenv': 'http://schemas.xmlsoap.org/soap/envelope/',
                'xmlns:tem': 'http://tempuri.org/'
            })
            .ele('soapenv:Header').up()
            .ele('soapenv:Body')
                .ele('tem:ErrorResponse')
                    .ele('tem:Message').txt(errorMessage).up()
                .up()
            .up()
        .end({ prettyPrint: true, headless: true });
    };

    try {
        var xpath = require('xpath');
        var DOMParser = require('xmldom').DOMParser; // CORRECTED

        var doc = new DOMParser().parseFromString(request.body, 'text/xml'); // CORRECTED

        const keyNodes = xpath.select("//*[local-name()='Key' and namespace-uri()='http://tempuri.org/']", doc);
        const dataNodes = xpath.select("//*[local-name()='Data' and namespace-uri()='http://tempuri.org/']", doc);

        let key = '';
        if (keyNodes.length > 0 && keyNodes[0].firstChild) {
            key = keyNodes[0].firstChild.data;
        }

        let xmlData = '';
        if (dataNodes.length > 0 && dataNodes[0].childNodes.length > 0) {
            for (let i = 0; i < dataNodes[0].childNodes.length; i++) {
                xmlData += dataNodes[0].childNodes[i].toString();
            }
        }
        
        if (!key || !xmlData) {
            const errorMessage = "Missing Key or XML Data in SOAP request body";
            return {
                statusCode: 400,
                headers: { 'Content-Type': 'application/soap+xml; charset=utf-8' },
                body: generateErrorXml(errorMessage)
            };
        }

        state.map[key] = xmlData;

        return {
            statusCode: 200,
            headers: { 'Content-Type': 'application/soap+xml; charset=utf-8' },
            body: generateSuccessXml("XML Data stored successfully")
        };
    } catch (e) {
        return {
            statusCode: 500,
            headers: { 'Content-Type': 'application/soap+xml; charset=utf-8' },
            body: generateErrorXml('Internal server error: ' + e.message)
        };
    }
}