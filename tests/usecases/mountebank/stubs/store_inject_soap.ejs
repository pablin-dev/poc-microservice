function (request, state) {
    state.map = state.map || {}; // Initialize map if it doesn't exist
    const ns = { tem: 'http://tempuri.org/', soapenv: 'http://schemas.xmlsoap.org/soap/envelope/' };
    const storeSuccessXml = `<soapenv:Envelope xmlns:soapenv="http://schemas.xmlsoap.org/soap/envelope/" xmlns:tem="http://tempuri.org/">
   <soapenv:Header/>
   <soapenv:Body>
      <tem:StoreResponse>
         <tem:Result>Stored successfully</tem:Result>
      </tem:StoreResponse>
   </soapenv:Body>
</soapenv:Envelope>`;
    const errorXml = `<soapenv:Envelope xmlns:soapenv="http://schemas.xmlsoap.org/soap/envelope/" xmlns:tem="http://tempuri.org/">
   <soapenv:Header/>
   <soapenv:Body>
      <tem:ErrorResponse>
         <tem:Message>ErrorMessagePlaceholder</tem:Message>
      </tem:ErrorResponse>
   </soapenv:Body>
</soapenv:Envelope>`;

    try {
        // Explicitly require xpath and xmldom for parsing
        var xpath = require('xpath');
        var dom = require('xmldom').DOMParser;

        // Parse the request body string into an XML DOM object
        var doc = new dom().parseFromString(request.body, 'text/xml');
        console.log('Type of parsed doc:', typeof doc);
        if (doc && doc.documentElement) {
            console.log('Document Element Name:', doc.documentElement.nodeName);
        } else {
            console.log('Doc or Document Element is null/undefined.');
        }

        const key = xpath.select("//*[local-name()='Key' and namespace-uri()='http://tempuri.org/']", doc)[0].firstChild.data;
        const value = xpath.select("//*[local-name()='Value' and namespace-uri()='http://tempuri.org/']", doc)[0].firstChild.data;

        if (!key || !value) {
            const errorMessage = "Missing Key or Value in SOAP request body";
            let errorResponse = errorXml.replace('ErrorMessagePlaceholder', errorMessage);
            return {
                statusCode: 400,
                headers: { 'Content-Type': 'application/soap+xml; charset=utf-8' },
                body: errorResponse
            };
        }

        state.map[key] = value;

        return {
            statusCode: 200,
            headers: { 'Content-Type': 'application/soap+xml; charset=utf-8' },
            body: storeSuccessXml
        };
    } catch (e) {
        let errorResponse = errorXml.replace('ErrorMessagePlaceholder', 'Internal server error: ' + e.message);
        return {
            statusCode: 500,
            headers: { 'Content-Type': 'application/soap+xml; charset=utf-8' },
            body: errorResponse
        };
    }
}